<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTS BIO-DT ì¢…í•© ì±—ë´‡ (Redmine + CRF)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 90%;
            max-width: 1000px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-content {
            max-width: 90%;
            min-width: 200px;
            padding: 15px 20px;
            border-radius: 15px;
            word-wrap: break-word;
            width: fit-content;
        }

        /* í‘œê°€ ìˆì„ ë•Œ ë§í’ì„  í™•ì¥ */
        .message-content:has(table) {
            max-width: 95%;
        }

        .ellipsis-dots {
            display: flex;
            gap: 6px;
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .ellipsis-dots .dot {
            animation: dotPulse 1.2s infinite ease-in-out;
            opacity: 0.2;
        }

        .ellipsis-dots .dot:nth-child(2) { animation-delay: 0.15s; }
        .ellipsis-dots .dot:nth-child(3) { animation-delay: 0.3s; }

        @keyframes dotPulse {
            0%, 60%, 100% { opacity: 0.2; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-2px); }
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .message.bot .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        /* ë¡œë”© ë²„ë¸”: ì ë§Œ ë³´ì´ë„ë¡ ë°°ê²½/í…Œë‘ë¦¬ ì œê±° */
        .message.bot.loading .message-content,
        .message.loading .message-content {
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            min-width: unset;
            max-width: unset;
            border-radius: 0;
        }
        
        .sources {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            font-size: 13px;
        }
        
        .sources a {
            display: inline-block;
            margin: 5px 10px 5px 0;
            padding: 5px 10px;
            background: #f0f0f0;
            border-radius: 5px;
            color: #667eea;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            pointer-events: auto;
        }

        .sources a:hover {
            background: #667eea;
            color: white;
        }

        .sources a:active {
            transform: scale(0.98);
        }
        
        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        
        #question-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #question-input:focus {
            border-color: #667eea;
        }
        
        #send-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        #send-btn:hover {
            transform: scale(1.05);
        }
        
        #send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1);
        }

        /* ì·¨ì†Œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #send-btn.cancel-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        #send-btn.cancel-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        }
        
        .timestamp {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ ê°œì„  */
        .message-content table {
            min-width: 600px;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message-content table th,
        .message-content table td {
            white-space: nowrap;
            min-width: 80px;
        }

        /* í…Œì´ë¸”ì´ ë§í’ì„ ì„ ë„˜ì¹  ê²½ìš° ìŠ¤í¬ë¡¤ */
        .message-content:has(table) {
            overflow-x: auto;
        }

        /* ê°€ì´ë“œ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close {
            color: white;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            opacity: 0.8;
        }

        .modal-body {
            padding: 30px;
            line-height: 1.8;
        }

        .modal-body h3 {
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .modal-body h3:first-child {
            margin-top: 0;
        }

        .prompt-example {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prompt-example:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .prompt-example .category {
            color: #667eea;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .prompt-example .text {
            color: #333;
            margin-bottom: 5px;
        }

        .prompt-example .desc {
            color: #666;
            font-size: 13px;
        }

        .tip-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .warning-box {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        /* ì‚¬ìš©ì ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ */
        .name-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }

        .name-modal-content {
            background: white;
            margin: 15% auto;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            text-align: center;
        }

        .name-modal-content h2 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .name-modal-content p {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .name-input-group {
            margin-bottom: 25px;
        }

        .name-input-group input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .name-input-group input:focus {
            border-color: #667eea;
        }

        .name-submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .name-submit-btn:hover {
            transform: scale(1.02);
        }

        .name-submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .change-user-btn {
            background: rgba(255,255,255,0.3);
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: background 0.2s;
        }

        .change-user-btn:hover {
            background: rgba(255,255,255,0.4);
        }
    </style>
</head>
<body>
    <!-- ì‚¬ìš©ì ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="nameModal" class="name-modal">
        <div class="name-modal-content">
            <h2>ğŸ‘¤ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
            <p>ëŒ€í™”ë¥¼ ì‹œì‘í•˜ê¸° ì „ì— ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            <div class="name-input-group">
                <input
                    type="text"
                    id="userNameInput"
                    placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: bio-dt)"
                    maxlength="20"
                    autocomplete="off"
                >
            </div>
            <button class="name-submit-btn" onclick="setUserName()">
                ì‹œì‘í•˜ê¸°
            </button>
        </div>
    </div>

    <div class="container">
        <div class="header" id="mainHeader">
            <h1>MTS BIO-DT ì¢…í•© ì±—ë´‡</h1>
            <p>Redmine ì‹¤í—˜ ë°ì´í„° + CRF ìœ ë°©ì•” ë°ì´í„° ê²€ìƒ‰ ì‹œìŠ¤í…œ</p>
        </div>
        
        <div class="chat-container" id="chat-box">
            <div class="message bot">
                <div class="message-content">
                    ì•ˆë…•í•˜ì„¸ìš”. <strong>MTS BIO-DT ì¢…í•© ì±—ë´‡</strong>ì…ë‹ˆë‹¤.<br><br>

                    <strong>ì£¼ìš” ê¸°ëŠ¥</strong><br>
                    <strong>Redmine</strong>: ê³¼ê±° ì‹¤í—˜ ë°ì´í„° ê²€ìƒ‰, ëª¨ë¸ ì„±ëŠ¥ ì§€í‘œ ì¡°íšŒ<br>
                    <strong>CRF</strong>: ìœ ë°©ì•” ì„ìƒ ë°ì´í„° ê²€ìƒ‰, í™˜ì ì •ë³´ ì¡°íšŒ<br><br>

                    <a href="#" onclick="showGuideRedmine(); return false;" style="color: #667eea; text-decoration: underline; font-weight: 500;">ì‚¬ìš© ê°€ì´ë“œ (Redmine)</a><br>
                    <a href="#" onclick="showGuideCRF(); return false;" style="color: #e91e63; text-decoration: underline; font-weight: 500;">ì‚¬ìš© ê°€ì´ë“œ (CRF)</a><br>
                    <a href="#" onclick="showUserList(); return false;" style="color: #28a745; text-decoration: underline; font-weight: 500;">ì‚¬ìš©ì ëª©ë¡ ë³´ê¸°</a><br><br>

                </div>
            </div>
        </div>
        
        <div class="input-container">
            <input 
                type="text" 
                id="question-input" 
                placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
                autocomplete="off"
            >
            <button id="send-btn" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ëª©ë¡ ëª¨ë‹¬ -->
    <div id="userListModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ì‚¬ìš©ì ëª©ë¡</h2>
                <span class="close" onclick="closeUserList()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="userListContent">
                    <div style="text-align: center; color: #999; padding: 20px;">
                        ë¡œë”© ì¤‘...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Redmine ê°€ì´ë“œ ëª¨ë‹¬ -->
    <div id="guideModalRedmine" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Redmine ì‚¬ìš© ê°€ì´ë“œ</h2>
                <span class="close" onclick="closeGuideRedmine()">&times;</span>
            </div>
            <div class="modal-body">
                <h3>1. ê°œìš”</h3>
                <p>
                    <strong>Redmine</strong>: ê³¼ê±° ì‹¤í—˜ ë°ì´í„°, ëª¨ë¸ ì„±ëŠ¥ ì§€í‘œ, ì´ìŠˆ ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.
                </p>

                <h3>2. ì§ˆë¬¸ ì˜ˆì‹œ - Redmine (ì‹¤í—˜ ë°ì´í„°)</h3>

                <div class="success-box">
                    <strong>ì§ˆë¬¸ ì˜ˆì‹œ (í´ë¦­í•˜ë©´ ìë™ ì…ë ¥ë©ë‹ˆë‹¤)</strong>
                </div>

                <div class="prompt-example" onclick="usePrompt('ìµœì‹  mitof-objectDet-blad ëª¨ë¸ì˜ f1-scoreëŠ”?')">
                    <div class="category">ì„±ëŠ¥ ì§€í‘œ ì¡°íšŒ</div>
                    <div class="text">"ìµœì‹  mitof-objectDet-blad ëª¨ë¸ì˜ f1-scoreëŠ”?"</div>
                    <div class="desc">íŠ¹ì • ëª¨ë¸ì˜ ì„±ëŠ¥ ì§€í‘œë¥¼ í™•ì¸í•  ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('BRAF Mutation ëª¨ë¸ v0.7.0ì˜ ì‹¤í—˜ ê²°ê³¼ ìš”ì•½í•´ì¤˜')">
                    <div class="category">íŠ¹ì • ë²„ì „ ê²€ìƒ‰</div>
                    <div class="text">"BRAF Mutation ëª¨ë¸ v0.7.0ì˜ ì‹¤í—˜ ê²°ê³¼ ìš”ì•½í•´ì¤˜"</div>
                    <div class="desc">ë²„ì „ë³„ ì‹¤í—˜ ê²°ê³¼ë¥¼ ë¹„êµí•  ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('Thyroid Mutation ê´€ë ¨ ìµœì‹  ì‹¤í—˜ 3ê°œ ë³´ì—¬ì¤˜')">
                    <div class="category">ì£¼ì œë³„ ê²€ìƒ‰</div>
                    <div class="text">"Thyroid Mutation ê´€ë ¨ ìµœì‹  ì‹¤í—˜ 3ê°œ ë³´ì—¬ì¤˜"</div>
                    <div class="desc">íŠ¹ì • ì£¼ì œì˜ ìµœê·¼ ì‹¤í—˜ì„ ì°¾ì„ ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('F1-scoreê°€ 0.8 ì´ìƒì¸ ëª¨ë¸ë“¤ì€?')">
                    <div class="category">ì¡°ê±´ ê²€ìƒ‰</div>
                    <div class="text">"F1-scoreê°€ 0.8 ì´ìƒì¸ ëª¨ë¸ë“¤ì€?"</div>
                    <div class="desc">íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ê²°ê³¼ë¥¼ ì°¾ì„ ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('HRD ëª¨ë¸ì˜ ìµœê·¼ ê°œì„  ì‚¬í•­ì€?')">
                    <div class="category">ê°œì„  ì¶”ì </div>
                    <div class="text">"HRD ëª¨ë¸ì˜ ìµœê·¼ ê°œì„  ì‚¬í•­ì€?"</div>
                    <div class="desc">ëª¨ë¸ì˜ ë°œì „ ê³¼ì •ì„ í™•ì¸í•  ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('PyTorch 1.13 í™˜ê²½ì—ì„œ ì‹¤í—˜í•œ ê²°ê³¼ ìˆì–´?')">
                    <div class="category">í™˜ê²½ë³„ ê²€ìƒ‰</div>
                    <div class="text">"PyTorch 1.13 í™˜ê²½ì—ì„œ ì‹¤í—˜í•œ ê²°ê³¼ ìˆì–´?"</div>
                    <div class="desc">íŠ¹ì • ê°œë°œ í™˜ê²½ì˜ ì‹¤í—˜ì„ ì°¾ì„ ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('GPU ë©”ëª¨ë¦¬ ë¶€ì¡± ì˜¤ë¥˜ í•´ê²° ë°©ë²• ì°¾ì•„ì¤˜')">
                    <div class="category">ë¬¸ì œ í•´ê²°</div>
                    <div class="text">"GPU ë©”ëª¨ë¦¬ ë¶€ì¡± ì˜¤ë¥˜ í•´ê²° ë°©ë²• ì°¾ì•„ì¤˜"</div>
                    <div class="desc">ê³¼ê±° ë¬¸ì œ í•´ê²° ì‚¬ë¡€ë¥¼ ì°¾ì„ ë•Œ</div>
                </div>

                <h3>3. ì œí•œì‚¬í•­</h3>
                <div class="warning-box">
                    <strong>ë‹µë³€í•˜ê¸° ì–´ë ¤ìš´ ì§ˆë¬¸</strong><br>
                    â€¢ ë¯¸ë˜ ê³„íšì— ëŒ€í•œ ì§ˆë¬¸ (ì˜ˆ: "ë‚´ì¼ ì‹¤í—˜ ë­í•˜ì§€?")<br>
                    â€¢ ì‹¤í—˜ ë°ì´í„°ì™€ ë¬´ê´€í•œ ì§ˆë¬¸ (ì˜ˆ: "ì»¤í”¼ ë§›ì§‘ ì¶”ì²œí•´ì¤˜")<br>
                    â€¢ ì½”ë“œ ìƒì„± ìš”ì²­ (ì˜ˆ: "ì½”ë“œ ì‘ì„±í•´ì¤˜")<br>
                    â€¢ ë„ˆë¬´ ì§§ê±°ë‚˜ ì• ë§¤í•œ ì§ˆë¬¸ (ì˜ˆ: "ì´ê±°", "ì„±ëŠ¥")
                </div>

                <h3>4. ì°¸ê³  ì‚¬í•­</h3>
                <p>
                    <strong>Redmine ë°ì´í„°:</strong><br>
                    â€¢ ë‹µë³€ í•˜ë‹¨ì— í‘œì‹œë˜ëŠ” <strong>"ì°¸ê³  ì´ìŠˆ"</strong> ë§í¬ë¥¼ í´ë¦­í•˜ë©´ Redmineì—ì„œ ê´€ë ¨ ì „ì²´ ì´ìŠˆë¥¼ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                    â€¢ ì •í™•í•œ ìˆ˜ì¹˜ë‚˜ ìƒì„¸ ë‚´ìš©ì€ ë°˜ë“œì‹œ ì›ë³¸ Redmine ì´ìŠˆë¥¼ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.<br><br>

                    <strong>ê³µí†µ:</strong><br>
                    â€¢ ì´ ì±—ë´‡ì€ ì‹¤ì‹œê°„ ëŒ€í™”ê°€ ì•„ë‹Œ ê³¼ê±° ë°ì´í„° ê²€ìƒ‰ ë„êµ¬ì…ë‹ˆë‹¤.<br>
                    â€¢ ëŒ€í™” ë§¥ë½ì„ ê¸°ì–µí•˜ë¯€ë¡œ ì—°ì†ëœ ì§ˆë¬¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </p>

            </div>
        </div>
    </div>

    <!-- CRF ê°€ì´ë“œ ëª¨ë‹¬ -->
    <div id="guideModalCRF" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>CRF ì‚¬ìš© ê°€ì´ë“œ</h2>
                <span class="close" onclick="closeGuideCRF()">&times;</span>
            </div>
            <div class="modal-body">
                <h3>1. ê°œìš”</h3>
                <p>
                    <strong>CRF</strong>: ìœ ë°©ì•” ì„ìƒ ë°ì´í„°, í™˜ì ì •ë³´, ë³‘ë¦¬ ë°ì´í„°ë¥¼ ê²€ìƒ‰/í†µê³„/ì°¨íŠ¸ë¡œ í™•ì¸í•©ë‹ˆë‹¤.
                </p>

                <h3 style="color: #e91e63;">2. ì§ˆë¬¸ ì˜ˆì‹œ - CRF (ìœ ë°©ì•” ì„ìƒ ë°ì´í„°)</h3>

                <h4 style="color: #e91e63; margin-top: 10px;">CRF - ì¼ë°˜ ì§ˆë¬¸</h4>

                <div class="prompt-example" onclick="usePrompt('ë³‘ë¦¬ë²ˆí˜¸ BC_05_0029 í™˜ì ì •ë³´ ì•Œë ¤ì¤˜')" style="border-left-color: #e91e63;">
                    <div class="category" style="color: #e91e63;">CRF - ê°œë³„ í™˜ì</div>
                    <div class="text">"ë³‘ë¦¬ë²ˆí˜¸ BC_05_0029 í™˜ì ì •ë³´ ì•Œë ¤ì¤˜"</div>
                    <div class="desc">ë³‘ë¦¬ë²ˆí˜¸ë¡œ íŠ¹ì • í™˜ìë¥¼ ì°¾ì„ ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('HER2 ìŒì„±ì´ë©´ì„œ Ki67 20% ì´ìƒ ì‚¬ë¡€ 5ê°œë§Œ ë³´ì—¬ì¤˜')" style="border-left-color: #e91e63;">
                    <div class="category" style="color: #e91e63;">CRF - ì¡°ê±´ ìƒ˜í”Œ ì¡°íšŒ</div>
                    <div class="text">"HER2 ìŒì„±ì´ë©´ì„œ Ki67 20% ì´ìƒ ì‚¬ë¡€ 5ê°œë§Œ ë³´ì—¬ì¤˜"</div>
                    <div class="desc">ì¡°ê±´ í•„í„° í›„ ìƒìœ„ ì‚¬ë¡€ ëª‡ ê±´ì„ í™•ì¸í•  ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('ì„¸ë¸Œë€ìŠ¤ Breast í†µí•© ë°ì´í„°ì—ì„œ ìµœê·¼ ì‚¬ë¡€ 5ê±´ ë³´ì—¬ì¤˜')" style="border-left-color: #e91e63;">
                    <div class="category" style="color: #e91e63;">CRF - ë³‘ì›/ì‹œíŠ¸ë³„ ìƒ˜í”Œ</div>
                    <div class="text">"ì„¸ë¸Œë€ìŠ¤ Breast í†µí•© ë°ì´í„°ì—ì„œ ìµœê·¼ ì‚¬ë¡€ 5ê±´ ë³´ì—¬ì¤˜"</div>
                    <div class="desc">íŠ¹ì • ë³‘ì›/ì‹œíŠ¸ì—ì„œ ìµœì‹  ì‚¬ë¡€ë¥¼ ëª‡ ê±´ë§Œ ë³¼ ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('ìˆ˜ìˆ ëª…ì— partial í¬í•¨ëœ ê¸°ë¡ 3ê°œë§Œ ì•Œë ¤ì¤˜')" style="border-left-color: #e91e63;">
                    <div class="category" style="color: #e91e63;">CRF - í•„ë“œ ê°’ ìƒ˜í”Œ</div>
                    <div class="text">"ìˆ˜ìˆ ëª…ì— partial í¬í•¨ëœ ê¸°ë¡ 3ê°œë§Œ ì•Œë ¤ì¤˜"</div>
                    <div class="desc">íŠ¹ì • í•„ë“œ ê°’ì´ í¬í•¨ëœ ì‚¬ë¡€ë¥¼ ì†Œìˆ˜ë§Œ ì¡°íšŒí•  ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('2020ë…„ ì´í›„ ìˆ˜ìˆ í•œ í™˜ì ì‚¬ë¡€ 5ê°œë§Œ ë³´ì—¬ì¤˜')" style="border-left-color: #e91e63;">
                    <div class="category" style="color: #e91e63;">CRF - ë‚ ì§œ ì¡°ê±´ ìƒ˜í”Œ</div>
                    <div class="text">"2020ë…„ ì´í›„ ìˆ˜ìˆ í•œ í™˜ì ì‚¬ë¡€ 5ê°œë§Œ ë³´ì—¬ì¤˜"</div>
                    <div class="desc">ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ í•„í„°í•œ ì‚¬ë¡€ë¥¼ ëª‡ ê±´ë§Œ í™•ì¸í•  ë•Œ</div>
                </div>

                <h4 style="color: #e91e63; margin-top: 18px;">CRF - ë°ì´í„° í˜„í™©</h4>

                <div class="prompt-example" onclick="usePrompt('ê° ë³‘ì›ë³„ ë°ì´í„° ìˆ˜ ì•Œë ¤ì¤˜')" style="border-left-color: #e91e63;">
                    <div class="category" style="color: #e91e63;">CRF - ë©”íƒ€ ì •ë³´</div>
                    <div class="text">"ê° ë³‘ì›ë³„ ë°ì´í„° ìˆ˜ ì•Œë ¤ì¤˜"</div>
                    <div class="desc">ë³‘ì›ë³„ ë°ì´í„° ê±´ìˆ˜ì™€ ìˆ˜ì§‘ í˜„í™©ì„ ìš”ì•½í•  ë•Œ</div>
                </div>

                <h4 style="color: #e91e63; margin-top: 18px;">CRF - í†µê³„/ì°¨íŠ¸</h4>

                <div class="prompt-example" onclick="usePrompt('HER2 ì–‘ì„± í™˜ì í†µê³„/ë¹„ìœ¨ ìš”ì•½í•´ì¤˜')" style="border-left-color: #e91e63;">
                    <div class="category" style="color: #e91e63;"> CRF - í†µê³„ ì¡°íšŒ</div>
                    <div class="text">"HER2 ì–‘ì„± í™˜ì í†µê³„/ë¹„ìœ¨ ìš”ì•½í•´ì¤˜"</div>
                    <div class="desc">íŠ¹ì • ë°”ì´ì˜¤ë§ˆì»¤ ì–‘ì„± í™˜ìì˜ ë¹„ìœ¨/ê±´ìˆ˜ í†µê³„ë¥¼ í™•ì¸í•  ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('ER/PR ì–‘ì„± Â· HER2 ìŒì„± í™˜ì í†µê³„ ì•Œë ¤ì¤˜')" style="border-left-color: #e91e63;">
                    <div class="category" style="color: #e91e63;"> CRF - í†µê³„ ì¡°íšŒ</div>
                    <div class="text">"ER/PR ì–‘ì„± Â· HER2 ìŒì„± í™˜ì í†µê³„ ì•Œë ¤ì¤˜"</div>
                    <div class="desc">ë³µí•© ì¡°ê±´ í™˜ìì˜ ì „ì²´ ë¹„ìœ¨/ê±´ìˆ˜ë¥¼ ìš”ì•½í•  ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('ì„¸ë¸Œë€ìŠ¤ ë³‘ì› í™˜ì ì „ì²´ í†µê³„ ìš”ì•½í•´ì¤˜')" style="border-left-color: #e91e63;">
                    <div class="category" style="color: #e91e63;"> CRF - í†µê³„ ì¡°íšŒ</div>
                    <div class="text">"ì„¸ë¸Œë€ìŠ¤ ë³‘ì› í™˜ì ì „ì²´ í†µê³„ ìš”ì•½í•´ì¤˜"</div>
                    <div class="desc">íŠ¹ì • ë³‘ì›ì˜ ì „ì²´ í™˜ì ìˆ˜/ë¶„í¬ë¥¼ ìš”ì•½í•  ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('Ki67 20% ì´ìƒ í™˜ì í†µê³„ ì•Œë ¤ì¤˜')" style="border-left-color: #e91e63;">
                    <div class="category" style="color: #e91e63;"> CRF - í†µê³„ ì¡°íšŒ</div>
                    <div class="text">"Ki67 20% ì´ìƒ í™˜ì í†µê³„ ì•Œë ¤ì¤˜"</div>
                    <div class="desc">ë³‘ë¦¬ ì§€í‘œ ê¸°ì¤€ìœ¼ë¡œ ì „ì²´ ë¹„ìœ¨/ê±´ìˆ˜ë¥¼ í™•ì¸í•  ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('íê²½ ì „ í˜¸ë¥´ëª¬ ì–‘ì„± í™˜ì í†µê³„ ìš”ì•½í•´ì¤˜')" style="border-left-color: #e91e63;">
                    <div class="category" style="color: #e91e63;"> CRF - í†µê³„ ì¡°íšŒ</div>
                    <div class="text">"íê²½ ì „ í˜¸ë¥´ëª¬ ì–‘ì„± í™˜ì í†µê³„ ìš”ì•½í•´ì¤˜"</div>
                    <div class="desc">ì„ìƒ íŠ¹ì„± ê¸°ì¤€ìœ¼ë¡œ ì „ì²´ ë¹„ìœ¨/ê±´ìˆ˜ë¥¼ í™•ì¸í•  ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('Triple Negative ìœ ë°©ì•” í™˜ì í†µê³„')" style="border-left-color: #e91e63;">
                    <div class="category" style="color: #e91e63;"> CRF - í†µê³„ ì¡°íšŒ</div>
                    <div class="text">"Triple Negative ìœ ë°©ì•” í™˜ì í†µê³„"</div>
                    <div class="desc">íŠ¹ì • ìœ í˜•ì˜ í™˜ì í†µê³„ë¥¼ í™•ì¸í•  ë•Œ</div>
                </div>

                <div class="prompt-example" onclick="usePrompt('ê³„ëª…ëŒ€ ë³‘ì›ì—ì„œ ìˆ˜ì§‘í•œ ë°ì´í„° í†µê³„ ë³´ì—¬ì¤˜')" style="border-left-color: #e91e63;">
                    <div class="category" style="color: #e91e63;"> CRF - ê¸°ê´€ë³„ í†µê³„</div>
                    <div class="text">"ê³„ëª…ëŒ€ ë³‘ì›ì—ì„œ ìˆ˜ì§‘í•œ ë°ì´í„° í†µê³„ ë³´ì—¬ì¤˜"</div>
                    <div class="desc">íŠ¹ì • ì˜ë£Œê¸°ê´€ì˜ ì „ì²´ ë°ì´í„°ë¥¼ ë¶„ì„í•  ë•Œ</div>
                </div>

                <h3>3. ì œí•œì‚¬í•­</h3>
                <div class="warning-box">
                    <strong>ë‹µë³€í•˜ê¸° ì–´ë ¤ìš´ ì§ˆë¬¸</strong><br>
                    â€¢ ë¯¸ë˜ ê³„íšì— ëŒ€í•œ ì§ˆë¬¸ (ì˜ˆ: "ë‚´ì¼ ì‹¤í—˜ ë­í•˜ì§€?")<br>
                    â€¢ ì‹¤í—˜ ë°ì´í„°ì™€ ë¬´ê´€í•œ ì§ˆë¬¸ (ì˜ˆ: "ì»¤í”¼ ë§›ì§‘ ì¶”ì²œí•´ì¤˜")<br>
                    â€¢ ì½”ë“œ ìƒì„± ìš”ì²­ (ì˜ˆ: "ì½”ë“œ ì‘ì„±í•´ì¤˜")<br>
                    â€¢ ë„ˆë¬´ ì§§ê±°ë‚˜ ì• ë§¤í•œ ì§ˆë¬¸ (ì˜ˆ: "ì´ê±°", "ì„±ëŠ¥")
                </div>

                <h3>4. ì°¸ê³  ì‚¬í•­</h3>
                <p>
                    <strong>CRF ë°ì´í„°:</strong><br>
                    â€¢ ë‹µë³€ í•˜ë‹¨ì— í‘œì‹œë˜ëŠ” <strong>"ì°¸ê³  ë°ì´í„°"</strong>ëŠ” ì‹¤ì œ í™˜ì ë°ì´í„° ì¶œì²˜ ì •ë³´ì…ë‹ˆë‹¤.<br>
                    â€¢ Record ID, ë³‘ì›ëª…, ë³‘ë¦¬ë²ˆí˜¸, ì‹œíŠ¸ ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>
                    â€¢ ë¯¼ê°í•œ ê°œì¸ì •ë³´ì´ë¯€ë¡œ ì™¸ë¶€ ìœ ì¶œì— ì£¼ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.<br><br>

                    <strong>ê³µí†µ:</strong><br>
                    â€¢ ì´ ì±—ë´‡ì€ ì‹¤ì‹œê°„ ëŒ€í™”ê°€ ì•„ë‹Œ ê³¼ê±° ë°ì´í„° ê²€ìƒ‰ ë„êµ¬ì…ë‹ˆë‹¤.<br>
                    â€¢ ëŒ€í™” ë§¥ë½ì„ ê¸°ì–µí•˜ë¯€ë¡œ ì—°ì†ëœ ì§ˆë¬¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </p>

            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
        // ============================================
        const chatBox = document.getElementById('chat-box');
        const questionInput = document.getElementById('question-input');
        const sendBtn = document.getElementById('send-btn');
        const initialChatHTML = chatBox.innerHTML; // ì´ˆê¸° ì•ˆë‚´/ê°€ì´ë“œëŠ” ë¦¬ì…‹ í›„ì—ë„ ìœ ì§€
        let currentAbortController = null; // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìš”ì²­ì„ ì·¨ì†Œí•˜ê¸° ìœ„í•œ ì»¨íŠ¸ë¡¤ëŸ¬
        let currentLoadingMessage = null; // ì§„í–‰ ì¤‘ì¸ ë¡œë”© ë©”ì‹œì§€ ë²„ë¸”

        // ============================================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // ============================================

        /**
         * ì…ë ¥ì°½ê³¼ ì „ì†¡ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
         * @param {boolean} disabled - true: ë¹„í™œì„±í™”, false: í™œì„±í™”
         */
        function toggleChatInputs(disabled) {
            questionInput.disabled = disabled;
            sendBtn.disabled = disabled;
        }

        /**
         * í™”ë©´ì˜ ëŒ€í™” ë‚´ìš© ì´ˆê¸°í™” (ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ë§Œ ë‚¨ê¹€)
         */
        function resetConversationUI() {
            chatBox.innerHTML = initialChatHTML;
        }

        /**
         * ì„œë²„ ì„¸ì…˜ ì´ˆê¸°í™” (ëŒ€í™” íˆìŠ¤í† ë¦¬ ì‚­ì œ)
         */
        async function resetServerSession() {
            try {
                await fetch('/reset', { method: 'POST' });
            } catch (e) {
                console.warn('ì„¸ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨(ë¬´ì‹œ):', e);
            }
        }

        // ============================================
        // ì‚¬ìš©ì ì´ë¦„ ê´€ë¦¬ í•¨ìˆ˜
        // ============================================

        /**
         * ì‚¬ìš©ì ì´ë¦„ ì„¤ì • ë° ì €ì¥
         */
        function setUserName() {
            const nameInput = document.getElementById('userNameInput');
            const userName = nameInput.value.trim();

            if (!userName) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            // íŠ¹ìˆ˜ë¬¸ì ì œê±° (ì•ŒíŒŒë²³, í•œê¸€, ìˆ«ìë§Œ í—ˆìš©)
            const cleanName = userName.replace(/[^a-zA-Z0-9ê°€-í£]/g, '');
            if (cleanName !== userName) {
                alert('íŠ¹ìˆ˜ë¬¸ìëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            const previousName = localStorage.getItem('userName');

            // localStorageì— ì €ì¥
            localStorage.setItem('userName', cleanName);

            // ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById('nameModal').style.display = 'none';

            // í—¤ë”ì— ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
            updateUserDisplay(cleanName);

            // ì‚¬ìš©ì ë³€ê²½ ì‹œ ëŒ€í™” UI/ì„¸ì…˜ ë¦¬ì…‹
            if (!previousName || previousName !== cleanName) {
                resetConversationUI();
                resetServerSession();
            }

            // ì…ë ¥ì°½ í™œì„±í™”
            toggleChatInputs(false);

            // ì…ë ¥ì°½ í¬ì»¤ìŠ¤
            questionInput.focus();
        }
        // [ì‚¬ìš©ì ì´ë¦„ ì„¤ì • í•¨ìˆ˜ ë]

        /**
         * í—¤ë”ì— ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
         * @param {string} userName - í‘œì‹œí•  ì‚¬ìš©ì ì´ë¦„
         */
        function updateUserDisplay(userName) {
            const header = document.getElementById('mainHeader');

            // ê¸°ì¡´ ì‚¬ìš©ì í‘œì‹œ ì œê±°
            const existingUserDiv = document.getElementById('currentUserDisplay');
            if (existingUserDiv) {
                existingUserDiv.remove();
            }

            // ìƒˆ ì‚¬ìš©ì í‘œì‹œ ì¶”ê°€
            const userDiv = document.createElement('div');
            userDiv.id = 'currentUserDisplay';
            userDiv.style.cssText = 'margin-top: 10px; font-size: 13px; color: white;';
            userDiv.innerHTML = `
                <span>ğŸ‘¤ ${userName}</span>
                <button onclick="changeUserName()" class="change-user-btn">ë³€ê²½</button>
            `;

            header.appendChild(userDiv);
        }
        // [ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ í•¨ìˆ˜ ë]

        /**
         * ì‚¬ìš©ì ì´ë¦„ ë³€ê²½ (í—¤ë”ì˜ "ë³€ê²½" ë²„íŠ¼ í´ë¦­ ì‹œ)
         */
        function changeUserName() {
            localStorage.removeItem('userName');
            document.getElementById('nameModal').style.display = 'flex';
            document.getElementById('userNameInput').value = '';
            document.getElementById('userNameInput').focus();

            // ëŒ€í™” UI/ì„¸ì…˜ ë¦¬ì…‹
            resetConversationUI();
            resetServerSession();

            // í—¤ë”ì—ì„œ ì‚¬ìš©ì í‘œì‹œ ì œê±°
            const existingUserDiv = document.getElementById('currentUserDisplay');
            if (existingUserDiv) {
                existingUserDiv.remove();
            }

            // ì…ë ¥ì°½ ë¹„í™œì„±í™”
            toggleChatInputs(true);
        }
        // [ì‚¬ìš©ì ì´ë¦„ ê´€ë¦¬ í•¨ìˆ˜ ë]

        // ============================================
        // ëª¨ë‹¬ ê´€ë¦¬ í•¨ìˆ˜
        // ============================================

        /** ì‚¬ìš© ê°€ì´ë“œ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° */
        function showGuideRedmine() {
            document.getElementById('guideModalRedmine').style.display = 'block';
        }
        function closeGuideRedmine() {
            document.getElementById('guideModalRedmine').style.display = 'none';
        }
        function showGuideCRF() {
            document.getElementById('guideModalCRF').style.display = 'block';
        }
        function closeGuideCRF() {
            document.getElementById('guideModalCRF').style.display = 'none';
        }

        /**
         * ì‚¬ìš©ì ëª©ë¡ ëª¨ë‹¬ ì—´ê¸° ë° ë°ì´í„° ë¡œë“œ
         */
        async function showUserList() {
            const modal = document.getElementById('userListModal');
            const contentDiv = document.getElementById('userListContent');

            modal.style.display = 'block';
            contentDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ë¡œë”© ì¤‘...</div>';

            try {
                const response = await fetch('/users');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ì‚¬ìš©ì ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                const users = data.users || [];

                if (users.length === 0) {
                    contentDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                // ì‚¬ìš©ì ëª©ë¡ í…Œì´ë¸” ìƒì„±
                let html = '<table border="1" style="border-collapse: collapse; width: 100%; margin: 10px 0;">';
                html += '<tr>';
                html += '<th style="background: #f0f0f0; padding: 10px; text-align: left;">ì‚¬ìš©ìëª…</th>';
                html += '<th style="background: #f0f0f0; padding: 10px; text-align: center;">ëŒ€í™” ìˆ˜</th>';
                html += '<th style="background: #f0f0f0; padding: 10px; text-align: center;">ìµœì´ˆ ì ‘ì†</th>';
                html += '<th style="background: #f0f0f0; padding: 10px; text-align: center;">ìµœê·¼ ì ‘ì†</th>';
                html += '<th style="background: #f0f0f0; padding: 10px; text-align: center;">ì‚­ì œ</th>';
                html += '</tr>';

                users.forEach(user => {
                    const firstSeen = user.first_seen ? new Date(user.first_seen).toLocaleString('ko-KR') : '-';
                    const lastSeen = user.last_seen ? new Date(user.last_seen).toLocaleString('ko-KR') : '-';

                    html += '<tr>';
                    html += `<td style="padding: 10px;"><strong>${user.user_name}</strong></td>`;
                    html += `<td style="padding: 10px; text-align: center;">${user.total_conversations}</td>`;
                    html += `<td style="padding: 10px; text-align: center;">${firstSeen}</td>`;
                    html += `<td style="padding: 10px; text-align: center;">${lastSeen}</td>`;
                    html += `<td style="padding: 10px; text-align: center;">
                        <button onclick="deleteUser('${user.user_name}')" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 5px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 12px;
                        ">ì‚­ì œ</button>
                    </td>`;
                    html += '</tr>';
                });

                html += '</table>';
                html += `<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; color: #666; font-size: 14px;">`;
                html += `ì´ <strong>${users.length}</strong>ëª…ì˜ ì‚¬ìš©ìê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`;
                html += `</div>`;

                contentDiv.innerHTML = html;

            } catch (error) {
                contentDiv.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 20px;">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        /**
         * ì‚¬ìš©ì ëª©ë¡ ëª¨ë‹¬ ë‹«ê¸°
         */
        function closeUserList() {
            document.getElementById('userListModal').style.display = 'none';
        }

        /**
         * ì‚¬ìš©ì ì‚­ì œ
         * @param {string} userName - ì‚­ì œí•  ì‚¬ìš©ì ì´ë¦„
         */
        async function deleteUser(userName) {
            if (!confirm(`ì •ë§ë¡œ '${userName}' ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ ì‚¬ìš©ìì˜ ëª¨ë“  ëŒ€í™” ê¸°ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                return;
            }

            try {
                const response = await fetch(`/users/${userName}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`'${userName}' ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    showUserList();
                } else {
                    throw new Error(data.error || 'ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (error) {
                alert(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
            }
        }

        /**
         * ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° (ëª¨ë“  ëª¨ë‹¬ ê³µí†µ)
         */
        window.onclick = (e) => {
            if (e.target.id === 'guideModalRedmine') closeGuideRedmine();
            if (e.target.id === 'guideModalCRF') closeGuideCRF();
            if (e.target.id === 'userListModal') closeUserList();
        };

        /**
         * ê°€ì´ë“œì˜ í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œë¥¼ ì…ë ¥ì°½ì— ì±„ìš°ê¸°
         * @param {string} promptText - ì…ë ¥í•  ì˜ˆì‹œ í…ìŠ¤íŠ¸
         */
        function usePrompt(promptText) {
            questionInput.value = promptText;
            closeGuideRedmine();
            closeGuideCRF();
            questionInput.focus();
        }
        // [ëª¨ë‹¬ ê´€ë¦¬ í•¨ìˆ˜ ë]

        // ============================================
        // ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜
        // ============================================

        /**
         * ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€
         * @returns {HTMLElement} ì¶”ê°€ëœ ë¡œë”© ë©”ì‹œì§€ ìš”ì†Œ
         */
        function addLoadingPlaceholder() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot loading';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.style.justifyContent = 'center';

            const dots = document.createElement('div');
            dots.className = 'ellipsis-dots';
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('span');
                dot.className = 'dot';
                dot.textContent = '.';
                dots.appendChild(dot);
            }

            contentDiv.appendChild(dots);
            messageDiv.appendChild(contentDiv);
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            return messageDiv;
        }

        /**
         * ë¡œë”© ë©”ì‹œì§€ ì œê±°
         * @param {HTMLElement} el - ì œê±°í•  ë¡œë”© ë©”ì‹œì§€ ìš”ì†Œ
         */
        function removeLoadingPlaceholder(el) {
            if (el && el.parentNode) {
                el.remove();
            }
        }

        /**
         * ë§ˆí¬ë‹¤ìš´ í‘œë¥¼ HTML í…Œì´ë¸”ë¡œ ë³€í™˜
         * @param {string} text - ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸
         * @returns {string} HTMLë¡œ ë³€í™˜ëœ í…ìŠ¤íŠ¸
         */
        function convertMarkdownTable(text) {
            const lines = text.split('\n');
            let html = text;
            let inTable = false;
            let tableLines = [];

            const processTable = (lines) => {
                let tableHtml = '<table border="1" style="border-collapse: collapse; margin: 10px 0; width: 100%;">';
                lines.forEach((line, idx) => {
                    if (line.includes('---')) return;
                    const cells = line.split('|').filter(cell => cell.trim() !== '');
                    const tag = idx === 0 ? 'th' : 'td';
                    const style = idx === 0 ?
                        'style="background: #f0f0f0; padding: 8px; text-align: left;"' :
                        'style="padding: 8px;"';
                    tableHtml += '<tr>';
                    cells.forEach(cell => tableHtml += `<${tag} ${style}>${cell.trim()}</${tag}>`);
                    tableHtml += '</tr>';
                });
                return tableHtml + '</table>';
            };

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('|') && line.endsWith('|')) {
                    if (!inTable) {
                        inTable = true;
                        tableLines = [];
                    }
                    tableLines.push(line);
                } else if (inTable && tableLines.length > 0) {
                    html = html.replace(tableLines.join('\n'), processTable(tableLines));
                    inTable = false;
                    tableLines = [];
                }
            }

            if (inTable && tableLines.length > 0) {
                html = html.replace(tableLines.join('\n'), processTable(tableLines));
            }

            return html.replace(/\n/g, '<br>');
        }

        /**
         * ì±„íŒ…ì°½ì— ë©”ì‹œì§€ ì¶”ê°€
         * @param {string} role - 'user' ë˜ëŠ” 'bot'
         * @param {string} content - ë©”ì‹œì§€ ë‚´ìš©
         * @param {Array} sources - ì°¸ê³  ì´ìŠˆ ëª©ë¡ (optional)
         * @param {Array} charts - ì°¨íŠ¸ ì´ë¯¸ì§€ ëª©ë¡ (optional)
         */
        function addMessage(role, content, sources = null, charts = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const formattedContent = convertMarkdownTable(content);

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = formattedContent;

            // ì°¨íŠ¸ ì´ë¯¸ì§€ ì¶”ê°€ (sources ì•ì— í‘œì‹œ)
            if (charts && charts.length > 0) {
                const chartsContainer = document.createElement('div');
                chartsContainer.style.cssText = 'margin: 15px 0;';

                charts.forEach((chart, idx) => {
                    const img = document.createElement('img');
                    img.src = `data:${chart.mime_type};base64,${chart.data}`;
                    img.alt = `Chart ${idx + 1}`;
                    img.style.cssText = 'max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                    chartsContainer.appendChild(img);
                });

                contentDiv.appendChild(chartsContainer);
            }

            // Sources ìš”ì†Œ ì¶”ê°€ (use_caseë³„ë¡œ ë‹¤ë¥´ê²Œ í‘œì‹œ)
            if (sources && sources.length > 0) {
                console.log('ì°¸ê³  sources:', sources);

                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'sources';

                const sourceTitle = document.createElement('strong');

                // Redmine ì´ìŠˆì¸ì§€ CRF ë°ì´í„°ì¸ì§€ êµ¬ë¶„
                const isRedmineIssue = sources[0].hasOwnProperty('issue_id');
                const isCRFData = sources[0].hasOwnProperty('record_id');

                if (isRedmineIssue) {
                    // Redmine ì´ìŠˆ í‘œì‹œ
                    sourceTitle.textContent = 'ì°¸ê³  ì´ìŠˆ:';
                    sourcesDiv.appendChild(sourceTitle);
                    sourcesDiv.appendChild(document.createElement('br'));

                    sources.forEach(s => {
                        const link = document.createElement('a');
                        link.href = s.url || '#';
                        link.textContent = `Issue #${s.issue_id}`;
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            if (s.url) {
                                window.open(s.url, '_blank', 'noopener');
                            }
                        });
                        link.rel = 'noopener noreferrer';
                        sourcesDiv.appendChild(link);
                    });
                } else if (isCRFData) {
                    // CRF ë°ì´í„° í‘œì‹œ (í´ë¦­ ë¶ˆê°€, ì •ë³´ë§Œ í‘œì‹œ)
                    sourceTitle.textContent = 'ì°¸ê³  ë°ì´í„°:';
                    sourcesDiv.appendChild(sourceTitle);
                    sourcesDiv.appendChild(document.createElement('br'));

                    sources.forEach(s => {
                        const dataInfo = document.createElement('div');
                        dataInfo.style.cssText = 'margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #555;';
                        dataInfo.textContent = `ğŸ“‹ ${s.record_id} | ë³‘ì›: ${s.hospital} | ë³‘ë¦¬ë²ˆí˜¸: ${s.path_no || 'N/A'} | ì‹œíŠ¸: ${s.sheet}`;
                        sourcesDiv.appendChild(dataInfo);
                    });
                } else {
                    // ì¼ë°˜ ë¬¸ì„œ í‘œì‹œ
                    sourceTitle.textContent = 'ì°¸ê³  ë¬¸ì„œ:';
                    sourcesDiv.appendChild(sourceTitle);
                    sourcesDiv.appendChild(document.createElement('br'));

                    sources.forEach(s => {
                        const docInfo = document.createElement('div');
                        docInfo.style.cssText = 'margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #555;';
                        docInfo.textContent = `ğŸ“„ ${s.filename} (${s.chunk_index + 1}/${s.total_chunks})`;
                        sourcesDiv.appendChild(docInfo);
                    });
                }

                contentDiv.appendChild(sourcesDiv);
            }

            // Timestamp ì¶”ê°€
            const timestampDiv = document.createElement('div');
            timestampDiv.className = 'timestamp';
            timestampDiv.textContent = new Date().toLocaleTimeString('ko-KR');
            contentDiv.appendChild(timestampDiv);

            messageDiv.appendChild(contentDiv);
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        // [ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜ ë]

        // ============================================
        // ì±„íŒ… ì „ì†¡ ë° ìš”ì²­ ê´€ë¦¬
        // ============================================

        /**
         * ì „ì†¡ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
         * @param {boolean} isCancel - true: ì·¨ì†Œ ë²„íŠ¼, false: ì „ì†¡ ë²„íŠ¼
         */
        function setButtonState(isCancel) {
            sendBtn.disabled = false;
            sendBtn.innerHTML = isCancel ? 'ì·¨ì†Œ' : 'ì „ì†¡';
            sendBtn.className = isCancel ? 'cancel-btn' : '';
            sendBtn.onclick = isCancel ? cancelRequest : sendMessage;
        }

        /**
         * ì„œë²„ ìš”ì²­ ì·¨ì†Œ
         */
        function cancelRequest() {
            if (currentAbortController) {
                currentAbortController.abort();
                currentAbortController = null;
                removeLoadingPlaceholder(currentLoadingMessage);
                currentLoadingMessage = null;
                setButtonState(false);
                addMessage('bot', 'ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        /**
         * ì§ˆë¬¸ì„ ì„œë²„ì— ì „ì†¡í•˜ê³  ì‘ë‹µ ë°›ê¸°
         */
        async function sendMessage() {
            const question = questionInput.value.trim();
            if (!question) return;

            const userName = localStorage.getItem('userName');
            if (!userName) {
                alert('ë¨¼ì € ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                document.getElementById('nameModal').style.display = 'flex';
                return;
            }

            addMessage('user', question);
            questionInput.value = '';

            currentAbortController = new AbortController();
            currentLoadingMessage = addLoadingPlaceholder();
            setButtonState(true);

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, user_name: userName }),
                    signal: currentAbortController.signal
                });

                const data = await response.json();
                removeLoadingPlaceholder(currentLoadingMessage);
                currentLoadingMessage = null;

                if (response.ok) {
                    // ì°¨íŠ¸ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                    if (data.charts && data.charts.length > 0) {
                        addMessage('bot', data.answer, data.sources, data.charts);
                    } else {
                        addMessage('bot', data.answer, data.sources);
                    }
                } else {
                    addMessage('bot', `ì˜¤ë¥˜: ${data.error}`);
                }
            } catch (error) {
                removeLoadingPlaceholder(currentLoadingMessage);
                currentLoadingMessage = null;
                if (error.name !== 'AbortError') {
                    addMessage('bot', `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
                }
            } finally {
                currentAbortController = null;
                setButtonState(false);
            }
        }
        
        // Enter í‚¤ ì´ë²¤íŠ¸
        questionInput.addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());
        document.getElementById('userNameInput').addEventListener('keypress', (e) => e.key === 'Enter' && setUserName());

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì´ë¦„ í™•ì¸
        window.onload = () => {
            toggleChatInputs(true);
            document.getElementById('userNameInput').value = localStorage.getItem('userName') || '';
            document.getElementById('nameModal').style.display = 'flex';
            document.getElementById('userNameInput').focus();
        };
    </script>
</body>
</html>
